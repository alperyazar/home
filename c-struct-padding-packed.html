<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ğŸ’¡ Tip 0: Do not let the structure padding or attribute((packed)) ruin your day | Alper Yazar</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="ğŸ’¡ Tip 0: Do not let the structure padding or attribute((packed)) ruin your day" />
<meta name="author" content="Alper Yazar" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="a True ğŸ‡¨ story" />
<meta property="og:description" content="a True ğŸ‡¨ story" />
<link rel="canonical" href="https://www.alperyazar.com/c-struct-padding-packed.html" />
<meta property="og:url" content="https://www.alperyazar.com/c-struct-padding-packed.html" />
<meta property="og:site_name" content="Alper Yazar" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-11-04T00:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ğŸ’¡ Tip 0: Do not let the structure padding or attribute((packed)) ruin your day" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alper Yazar"},"dateModified":"2025-05-09T19:32:32+03:00","datePublished":"2023-11-04T00:00:00+03:00","description":"a True ğŸ‡¨ story","headline":"ğŸ’¡ Tip 0: Do not let the structure padding or attribute((packed)) ruin your day","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alperyazar.com/c-struct-padding-packed.html"},"url":"https://www.alperyazar.com/c-struct-padding-packed.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">
    <script src="/assets/js/lazysizes.min.js" async=""></script><link type="application/atom+xml" rel="alternate" href="https://www.alperyazar.com/feed.xml" title="Alper Yazar" /><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico"><!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S3B80PC7FC"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-S3B80PC7FC');
    </script>

    

    
    <!-- Adsense -->
    <!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4580059638713287"
    crossorigin="anonymous"></script> -->
    <link rel="me" href="https://mastodon.social/@ayazar">
  </head>
<body><header class="site-header" role="banner">

    <div class="wrapper"><a class="site-title" rel="author" href="/">Alper Yazar</a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>

          <div class="trigger"><a class="page-link" href="/blog/">ğŸ“ Blog</a><a class="page-link" href="/search.html">ğŸ” Search</a><!-- <a class="page-link" href="https://ayazar.dev" target="_blank">ğŸ—‚ï¸ Notes</a> -->
            <a rel="me" class="page-link" href="https://www.linkedin.com/in/alperyazar" target="_blank">ğŸ’¼ LinkedIn</a>
            <a rel="me" class="page-link" href="https://www.youtube.com/@ayazar" target="_blank">ğŸ¬ YouTube</a>
          </div>
        </nav></div>
  </header>

  

<div id="son_yazi_banner" style="
background: linear-gradient(to right, rgba(250, 191, 200, 0.3), rgba(23, 86, 169, 0.2));
color: rgb(52, 55, 67);
text-align: center;
padding: 15px;
border-radius: 10px;
border: 0px dashed rgba(250, 191, 200, 0.5);
box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.1);
margin: 10px 0px 10px 0px;">ğŸš€ The latest blog post:&nbsp;<a href="/fpga-git-cicd-devops.html" style="font-weight: bold;"><span style="font-weight: bold;">FPGA, Git, DevOps, CI/CD</span></a>&nbsp;ğŸ‡¹ğŸ‡·</div>

  <div id="progressBar" class="progress-bar"></div>

  <script>
    // Listen for scroll events on the window
window.onscroll = function() {
    // Call the function to update the progress bar
    updateProgressBar();
};

function updateProgressBar() {
    // Get the total height of the page
    var scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    // Get the current scroll position
    var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    // Calculate the scroll percentage
    var scrollPercentage = (scrollTop / scrollHeight) * 100;
    // Update the width of the progress bar
    document.getElementById("progressBar").style.width = scrollPercentage + "%";
}
  </script>

<a href='/support.html' class="floating-icon-heart" width="48" target="_blank"><img src='/assets/img/icons8-heart-64.png' alt="â¤ï¸ Support/Destek" title="â¤ï¸ Support/Destek"></a>

<div id="special-flag">
  <a id="special-flag-link" href="#" target="_blank" title="">
    <img src='/assets/img/bayrak.png' alt="TÃ¼rk BayraÄŸÄ±">
  </a>
</div>

<script>
  /*
   * Ref: https://www.pau.edu.tr/tks/tr/sayfa/milli-ve-dini-bayramlar
   * Ref: https://www.mevzuat.gov.tr/mevzuat?MevzuatNo=859034&MevzuatTur=2&MevzuatTertip=5
   * Ref: https://www.eserotomatikbayrak.com/bayrak-asilacak-tarihler.pdf
   * Net bir ÅŸey bulmak zor :(
  */
  const specialDays = [
    ["03-18", "https://tr.wikipedia.org/wiki/18_Mart_%C3%87anakkale_Zaferi_ve_%C5%9Eehitleri_Anma_G%C3%BCn%C3%BC", "Ã‡anakkale Zaferi ve Åehitleri Anma GÃ¼nÃ¼"],
    ["04-23", "https://tr.wikipedia.org/wiki/23_Nisan_Ulusal_Egemenlik_ve_%C3%87ocuk_Bayram%C4%B1", "Ulusal Egemenlik ve Ã‡ocuk BayramÄ±"],
    ["05-01", "https://tr.wikipedia.org/wiki/1_May%C4%B1s_%C4%B0%C5%9F%C3%A7i_Bayram%C4%B1", "Emek ve DayanÄ±ÅŸma GÃ¼nÃ¼"],
    ["05-19", "https://tr.wikipedia.org/wiki/19_May%C4%B1s_Atat%C3%BCrk%27%C3%BC_Anma,_Gen%C3%A7lik_ve_Spor_Bayram%C4%B1", "AtatÃ¼rk'Ã¼ Anma, GenÃ§lik ve Spor BayramÄ±"],
    ["07-15", "https://tr.wikipedia.org/wiki/Demokrasi_ve_Mill%C3%AE_Birlik_G%C3%BCn%C3%BC", "Demokrasi ve MillÃ® Birlik GÃ¼nÃ¼"],
    ["08-30", "https://tr.wikipedia.org/wiki/30_A%C4%9Fustos_Zafer_Bayram%C4%B1", "Zafer BayramÄ±"],
    ["10-29", "https://tr.wikipedia.org/wiki/29_Ekim_Cumhuriyet_Bayram%C4%B1", "Cumhuriyet BayramÄ±"],
    ["11-10", "https://tr.wikipedia.org/wiki/10_Kas%C4%B1m_Atat%C3%BCrk%27%C3%BC_anma_g%C3%BCn%C3%BC_ve_Atat%C3%BCrk_haftas%C4%B1", "AtatÃ¼rk'Ã¼ Anma GÃ¼nÃ¼"]
  ];

  const today = new Date();
  const todayKey = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

  const match = specialDays.find(([key]) => key === todayKey);
  if (match) {
    const [_, url, tooltip] = match;
    const flagDiv = document.getElementById("special-flag");
    const flagLink = document.getElementById("special-flag-link");
    flagLink.href = url;
    flagLink.title = tooltip;
    flagDiv.style.display = "block";
  }
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">ğŸ’¡ Tip 0: Do not let the structure padding or __attribute__((__packed__)) ruin your day</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-11-04T00:00:00+03:00" itemprop="datePublished">
        2023-11-04
      </time>~<time class="dt-modified" datetime="2025-05-09T19:32:32+03:00" itemprop="dateModified">
        2025-05-09
      </time>â€¢ ğŸ‡¬ğŸ‡§<span> â€¢ 23-10</span>
      </p>
  </header><div style="background: #eeeeff; border-radius: 2px; margin: 2px;"><center><p><span data-nosnippet>ğŸ”¤ <small><a rel=â€nofollowâ€ href="https://www-alperyazar-com.translate.goog/c-struct-padding-packed.html?_x_tr_sl=auto&_x_tr_tl=tr">Google Translate ile Ã§evir</a></small>  ğŸ”¤</span></p></center></div><div class="post-content e-content" itemprop="articleBody"><p><i>a True ğŸ‡¨ story</i></p>
    <hr><div style="background: #ffec99; border-radius: 2px; margin: 2px;"><center><p><span data-nosnippet>â„¹ï¸ <small><a href="/disclaimer.html">Disclaimer</a></small> â„¹ï¸</span></p></center></div><hr>
    <p>Structures (the <code class="language-plaintext highlighter-rouge">struct</code> keyword) in C are widely used, especially in the
embedded world. For a couple of months, I have been writing a C program target
to <a href="https://www.xilinx.com/products/design-tools/microblaze.html">Microblaze</a>
processor, a 32-bit soft processor from AMD (Xilinx). While adding new features
to the existing code this week, I added a 1 char member to an existing
structure. After compiling the code, I noticed that the size of the elf file
(compiled code) decreased by 1.2 KB! The target is limited by 32 KB memory, and
I was close to the limit. 1.2 KB reduction was a huge improvement. So what
happened? I added a new code + 1 char and the size decreased, how? First, I
thought that the code I wrote was wrong and that the compiler was optimizing the
existing code due to a reason, such as dead code elimination. Then I immediately
realized that the change was due to 1 char addition to the existing structure,
not related to newly added code. But how?</p>

<p>If you are new to C programming, you may think that members of a struct are
placed in memory contiguously, like C arrays. <strong>âš ï¸ However, this assumption is
incorrect.</strong> A C compiler is free to insert padding bytes after structure members
to generate optimized and faster codes for the target architecture. However, you
can force the compiler not to insert <strong>padding bytes</strong> and to lay the struct members
in the memory contiguously, like an array. For example, adding the <strong>packed</strong>
attribute to a struct ,<code class="language-plaintext highlighter-rouge">__attribute__((__packed__))</code>, forces GCC to do that. There
could be several reasons doing that, and this is out of scope for now, but my
struct was <em>packed</em> too.</p>

<p>My structure is a little bit complex, 6-7 level of <code class="language-plaintext highlighter-rouge">struct</code>s and <code class="language-plaintext highlighter-rouge">union</code>s, and I
didnâ€™t notice that my 32-bit members were not word-aligned, i.e. on a 4 byte
boundary. Therefore, when I accessed a 32-bit struct member, like
<code class="language-plaintext highlighter-rouge">x.y = 0x12345678</code>
, the compiler was generating around 25 instructions to set a
variable! The word size of Microblaze processor is 32-bits, and it can work with
32-bit numbers natively given that they are stored on addresses that are a
multiple of 4: 0, 4, 8, 12, and so on.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Proper Alignment:

  |   0   |   1   |   2   |   3   |
0 |      32 bit  word  member 1   |
4 |      32 bit  word  member 2   |
</code></pre></div></div>

<p><em>Native</em> access (read/write) generates 1 or 2 instructions, not 25! Since I was
forcing the compiler not to add padding bytes and did the alignment wrong, the
32-bit members were unaligned, on addresses like 3, 7, 11â€¦ When this happens,
most of the time the C compiler generates (and have to) very inefficient code:
lots of byte access instead of word access, weird arithmetic and logical
operations and so on.. This is true for most architectures. I knew this before,
but this time due to complexity of the data structure, I made an alignment
mistake, damn! ğŸ¤¦</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  My Case ğŸ¤¦:

  |   0   |   1   |   2   |   3   |
0 |                       |   32  |
4 |  bit word member 1    |   32  |
8 |  bit word member 2    |  32.. |
</code></pre></div></div>

<p>So what happened when I added 1 char to my struct? You guessed right! I added
the <code class="language-plaintext highlighter-rouge">char</code> before 32-bit members and due to the new 1-byte member, they were
suddenly <em>pushed</em> to 4 byte alignment. The compiler was able to generate more
efficient instructions for the existing code sections that access those 32-bit
members. So even I added new code, optimization of previously unoptimized
sections decreased the final size.</p>

<h2 id="moral-of-the-story">Moral of the story</h2>

<p>ğŸ‘‰ In C, you can not assume that struct members are contiguous in memory, like
array members. Depending on the target architecture and the struct, most
probably, there will be padding bytes. If you are hearing this fact for the
first time and your existing code relies on this wrong assumption, please make
sure that you learn the limitations of structures well before padding bytes give
you a headache.</p>

<p>ğŸ‘‰ For some reason, you may not want those padding bytes. In this case, check
your compilerâ€™s manual to learn how to do this. This is a compiler specific
feature, not a part of a C standard.</p>

<p>ğŸ‘‰ <strong>Padding byte is not evil!</strong> These bytes are added to help generation of more
optimized code by compilers. You may think of them as a waste of memory, but if
you screw up with the alignment, your loss will be many times greater +
unoptimized code runtime penalty. If you are packing the struct, just make sure
that the alignment is still correct. Note that even if you allow padding bytes,
which is the default behavior as I mentioned, you may minimize them by ordering
the struct members carefully. But this is not our scope for now.</p>

<p>ğŸ‘‰ If you are targeting a memory limited platform or writing a performance
critical code, I find skimming over the generated assembly code by the compiler
time-to-time beneficial.</p>

<p>See you! ğŸ™‹â€â™‚ï¸</p>

    
    <hr>
    






    
    
    
<!--0-->
        
        
            
                
            
        
    
<!--1-->
        
        
            
                
            
        
    
<!--2-->
        
        
            
                
            
        
    
<!--3-->
        
        
            
                
                    
                    







<ul class="post-list">
<li style="background: #DDEEEE; padding: 10px; border-radius: 10px;">
<h4>ğŸ¤“ One more?</h4>
<h3>
<a class="post-link" href="/vivado-20164-node-locked-license-ubuntu.html">
Vivado 2016.4 Node Locked License Not Working on Ubuntu 16.04

</a>
</h3><h4>Vivado 2016.4 is obsessed with NIC naming</h4></li>
</ul>


  </div>

  
  <div class="revisions" style="border-top: 2px dashed; margin-top: 10px;"><h2 style="padding-top: 10px;">ğŸ”„ Updates (Last 10)</h2><ul style="list-style-type: none;">
    
      <li>
        <div class="post-meta"><code>2025-05-09</code> Revert "to ayazar.dev"
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2025-04-02</code> to ayazar.dev
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2025-03-30</code> Revert "to ayazar.dev"
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2025-03-16</code> to ayazar.dev
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2024-10-19</code> revert ayazar.dev
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2024-10-06</code> ayazar.dev
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2024-10-05</code> here
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2024-09-28</code> to ayazar.dev
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2024-09-14</code> revertx3
</div>
      </li>
    
      <li>
        <div class="post-meta"><code>2024-08-30</code> Revert "Revert "ayazar.dev""</div>
      </li>
    
    </ul>
  </div>
  <div class="gicus_comments" style="border-top: 2px dashed; margin-top: 10px;"><h2 style="padding-top: 10px;">ğŸ’­ Comments</h2>
  <p><small>Comments are provided by <a href="https://giscus.app/">giscus.</a>
    You need to use and authenticate your <a href="https://github.com/">GitHub</a> account to post a comment.
    Comments are stored on the <a href="https://github.com/alperyazar/home/discussions/categories/comments">Github Discussions.</a></small></p><script src="https://giscus.app/client.js"
        data-repo="alperyazar/home"
        data-repo-id="R_kgDOJoQiqA"
        data-category="Comments"
        data-category-id="DIC_kwDOJoQiqM4Cne4h"
        data-mapping="specific"
        data-term='23-10''
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"data-lang="en"data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
<p>ğŸ«† <code>23-10</code></p>
</div><a class="u-url" href="/c-struct-padding-packed.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Alper Yazar</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Alper Yazar</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/alperyazar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">alperyazar</span></a></li><li><a href="https://www.linkedin.com/in/alperyazar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">alperyazar</span></a></li><li><a href="https://mastodon.social/@ayazar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#mastodon"></use></svg> <span class="username">ayazar</span></a></li><li><a href="https://youtube.com/%40ayazar"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">@ayazar</span></a></li><li><a href="/feed.xml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#rss"></use></svg> <span>RSS</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>&quot;Full Stack Electronics&quot; Engineer<br/>Â© 2011 - 2025<br/><a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a></p>
        <p><a href="/disclaimer.html" />Disclaimer</a> <a href="/specimen.html" />Specimen</a> <a href="/" />Contact</a><br><a href='/support.html' />â¤ï¸ Destek / Support</a></p>
      </div>
    </div>

  </div>

</footer><!-- Default Statcounter code for Home
https://www.alperyazar.com -->
<script type="text/javascript">
  var sc_project=12712694;
  var sc_invisible=1;
  var sc_security="1c071fc4";
  </script>
  <script type="text/javascript"
  src="https://www.statcounter.com/counter/counter.js"
  async></script>
  <noscript><div class="statcounter"><a title="web statistics"
  href="https://statcounter.com/" target="_blank"><img
  class="statcounter"
  src="https://c.statcounter.com/12712694/0/1c071fc4/1/"
  alt="web statistics"
  referrerPolicy="no-referrer-when-downgrade"></a></div></noscript>
  <!-- End of Statcounter Code --></body>

</html>
